# Cyviz Architecture Diagrams

## Table of Contents
1. [System Overview](#system-overview)
2. [Component Architecture](#component-architecture)
3. [Data Flow Patterns](#data-flow-patterns)
4. [SignalR Communication](#signalr-communication)
5. [Command Pipeline](#command-pipeline)
6. [Database Schema](#database-schema)

---

## System Overview

### High-Level System Architecture

```
???????????????????????????????????????????????????????????????????????????????
?                            CYVIZ CONTROL SYSTEM                             ?
???????????????????????????????????????????????????????????????????????????????

???????????????????????         ???????????????????????         ????????????????????????
?                     ?         ?                     ?         ?                      ?
?  Operator Browser   ?         ?  Operator Browser   ?         ?   Edge Device        ?
?  (Dashboard UI)     ?         ?  (Dashboard UI)     ?         ?   (Display Wall)     ?
?                     ?         ?                     ?         ?                      ?
?  ?????????????????  ?         ?  ?????????????????  ?         ?  ??????????????????  ?
?  ? Blazor Server ?  ?         ?  ? Blazor Server ?  ?         ?  ?  EdgeSimulator ?  ?
?  ?   Component   ?  ?         ?  ?   Component   ?  ?         ?  ?   or Device    ?  ?
?  ?????????????????  ?         ?  ?????????????????  ?         ?  ?   Firmware     ?  ?
?          ?          ?         ?          ?          ?         ?  ??????????????????  ?
???????????????????????         ???????????????????????         ????????????????????????
           ?                               ?                                ?
           ? SignalR/WSS                   ? SignalR/WSS                    ? SignalR/WSS
           ? (BlazorHub)                   ? (BlazorHub)                    ? (DeviceHub)
           ?                               ?                                ?
????????????????????????????????????????????????????????????????????????????????????????
?                          ASP.NET CORE SERVER (Port 5000)                             ?
?                                                                                       ?
?  ???????????????????????????????????????????????????????????????????????????????    ?
?  ?                         PRESENTATION LAYER                                  ?    ?
?  ?                                                                             ?    ?
?  ?  ????????????????  ????????????????  ????????????????  ????????????????   ?    ?
?  ?  ?  Blazor Hub  ?  ? ControlHub   ?  ?  DeviceHub   ?  ? REST API     ?   ?    ?
?  ?  ?  (Auto)      ?  ? (SignalR)    ?  ?  (SignalR)   ?  ? /api/devices ?   ?    ?
?  ?  ????????????????  ????????????????  ????????????????  ????????????????   ?    ?
?  ?         ?                 ?                  ?                 ?           ?    ?
?  ??????????????????????????????????????????????????????????????????????????????    ?
?            ?                 ?                  ?                 ?                ?
?  ??????????????????????????????????????????????????????????????????????????????    ?
?  ?                        APPLICATION LAYER                                    ?    ?
?  ?                                                                             ?    ?
?  ?  ????????????????????  ??????????????????????  ????????????????????????   ?    ?
?  ?  ? CommandRouter    ?  ? DeviceStatusMonitor?  ?  EdgeSimulator       ?   ?    ?
?  ?  ? (HostedService)  ?  ? (HostedService)    ?  ?  (Simulation)        ?   ?    ?
?  ?  ?                  ?  ?                    ?  ?                      ?   ?    ?
?  ?  ? - Routes cmds    ?  ? - Health checks    ?  ? - Simulates devices  ?   ?    ?
?  ?  ? - Queues tasks   ?  ? - Status updates   ?  ? - Chaos testing      ?   ?    ?
?  ?  ? - Retry logic    ?  ? - Offline detection?  ?                      ?   ?    ?
?  ?  ????????????????????  ??????????????????????  ????????????????????????   ?    ?
?  ?                                                                             ?    ?
?  ???????????????????????????????????????????????????????????????????????????????    ?
?                                        ?                                            ?
?  ???????????????????????????????????????????????????????????????????????????????    ?
?  ?                         INFRASTRUCTURE LAYER                                ?    ?
?  ?                                                                             ?    ?
?  ?  ??????????????????????????????????????????????????????????????????????    ?    ?
?  ?  ?  Entity Framework Core (DbContext)                                 ?    ?    ?
?  ?  ?                                                                    ?    ?    ?
?  ?  ?  - AppDbContext                                                    ?    ?    ?
?  ?  ?  - IDbContextFactory<AppDbContext>                                 ?    ?    ?
?  ?  ?  - Migrations                                                      ?    ?    ?
?  ?  ??????????????????????????????????????????????????????????????????????    ?    ?
?  ?                                   ?                                        ?    ?
?  ??????????????????????????????????????????????????????????????????????????????    ?
?                                      ?                                             ?
?  ??????????????????????????????????????????????????????????????????????????????    ?
?  ?                      DOMAIN LAYER                                          ?    ?
?  ?                                                                             ?    ?
?  ?  ????????????  ??????????????????  ????????????????  ??????????????????   ?    ?
?  ?  ?  Device  ?  ? DeviceCommand  ?  ? Telemetry    ?  ?  Enums/Types   ?   ?    ?
?  ?  ????????????  ??????????????????  ????????????????  ??????????????????   ?    ?
?  ???????????????????????????????????????????????????????????????????????????????    ?
?                                                                                       ?
?????????????????????????????????????????????????????????????????????????????????????????
                                        ?
                                        ?
?????????????????????????????????????????????????????????????????????????????????????????
?                            SQLITE DATABASE (app.db)                                   ?
?                                                                                       ?
?  ????????????????????  ????????????????????  ??????????????????????                 ?
?  ?  Devices         ?  ?  Commands        ?  ?  Telemetry         ?                 ?
?  ?  - Id (PK)       ?  ?  - Id (PK)       ?  ?  - Id (PK)         ?                 ?
?  ?  - Name          ?  ?  - DeviceId      ?  ?  - DeviceId        ?                 ?
?  ?  - Type          ?  ?  - Command       ?  ?  - TimestampUtc    ?                 ?
?  ?  - Status        ?  ?  - Status        ?  ?  - Json            ?                 ?
?  ?  - LastSeenUtc   ?  ?  - Result        ?  ?                    ?                 ?
?  ?  - Capabilities  ?  ?  - IdempotencyKey?  ?                    ?                 ?
?  ????????????????????  ????????????????????  ??????????????????????                 ?
?                                                                                       ?
?????????????????????????????????????????????????????????????????????????????????????????
```

---

## Component Architecture

### Blazor Server Component Lifecycle

```
???????????????????????????????????????????????????????????????????????????
?                         BROWSER                                         ?
?                                                                         ?
?   User visits: https://localhost:5001/devices                          ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? HTTP GET /devices
                          ?
???????????????????????????????????????????????????????????????????????????
?                       ASP.NET CORE SERVER                               ?
?                                                                         ?
?   Step 1: Serve _Host.cshtml                                            ?
?   ???????????????????????????????????????????????????                   ?
?   ? <html>                                          ?                   ?
?   ?   <head>                                        ?                   ?
?   ?     <script src="_framework/blazor.server.js">?                   ?
?   ?   </head>                                       ?                   ?
?   ?   <body>                                        ?                   ?
?   ?     <app>Loading...</app>                       ?                   ?
?   ?   </body>                                       ?                   ?
?   ? </html>                                         ?                   ?
?   ???????????????????????????????????????????????????                   ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? Send HTML to browser
                          ?
???????????????????????????????????????????????????????????????????????????
?                         BROWSER                                         ?
?                                                                         ?
?   blazor.server.js executes                                             ?
?   Establishes SignalR connection to /_blazor                            ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? SignalR Handshake
                          ?
???????????????????????????????????????????????????????????????????????????
?                       ASP.NET CORE SERVER                               ?
?                                                                         ?
?   Step 2: Create Circuit & Component                                    ?
?   ???????????????????????????????????????????????????                   ?
?   ?  Circuit (Session) Created                      ?                   ?
?   ?    ??> Devices.razor component instantiated     ?                   ?
?   ?         ??> Dependency Injection                ?                   ?
?   ?              ??> IDbContextFactory injected     ?                   ?
?   ?                   ??> OnInitializedAsync()      ?                   ?
?   ?                        ??> Query Database       ?                   ?
?   ?                             ??> SELECT * FROM   ?                   ?
?   ?                                  Devices        ?                   ?
?   ???????????????????????????????????????????????????                   ?
?                                                                         ?
?   Step 3: Render Component                                              ?
?   ???????????????????????????????????????????????????                   ?
?   ?  Razor Template Rendered                        ?                   ?
?   ?  <table>                                        ?                   ?
?   ?    @foreach (var device in devices)             ?                   ?
?   ?    <tr><td>@device.Name</td></tr>               ?                   ?
?   ?  </table>                                       ?                   ?
?   ???????????????????????????????????????????????????                   ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? SignalR: Send rendered HTML
                          ?
???????????????????????????????????????????????????????????????????????????
?                         BROWSER                                         ?
?                                                                         ?
?   Blazor.js receives HTML and applies to DOM                            ?
?   ???????????????????????????????????????????????????                   ?
?   ? <table>                                         ?                   ?
?   ?   <tr><td>DisplayWall-1</td></tr>               ?                   ?
?   ?   <tr><td>DisplayWall-2</td></tr>               ?                   ?
?   ? </table>                                        ?                   ?
?   ???????????????????????????????????????????????????                   ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????????????????
?                      USER INTERACTION                                   ?
???????????????????????????????????????????????????????????????????????????

User clicks button: <button @onclick="DeleteDevice">Delete</button>

???????????????????????????????????????????????????????????????????????????
?                         BROWSER                                         ?
?   Click event captured by Blazor.js                                     ?
?   SignalR: Send event to server                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? SignalR: "Button_Click"
                          ?
???????????????????????????????????????????????????????????????????????????
?                       ASP.NET CORE SERVER                               ?
?                                                                         ?
?   Execute DeleteDevice() method                                         ?
?   ???????????????????????????????????????????????????                   ?
?   ?  await using var db = await _factory            ?                   ?
?   ?      .CreateDbContextAsync();                   ?                   ?
?   ?  var device = await db.Devices.FindAsync(id);   ?                   ?
?   ?  db.Devices.Remove(device);                     ?                   ?
?   ?  await db.SaveChangesAsync();                   ?                   ?
?   ?     ?                                           ?                   ?
?   ?  DELETE FROM Devices WHERE Id = 'device-01'     ?                   ?
?   ???????????????????????????????????????????????????                   ?
?                                                                         ?
?   Re-render component (device removed from list)                        ?
?   Compute HTML diff                                                     ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
                          ?
                          ? SignalR: Send HTML diff
                          ? (Only changed elements)
                          ?
???????????????????????????????????????????????????????????????????????????
?                         BROWSER                                         ?
?                                                                         ?
?   Apply diff: Remove <tr> for deleted device                            ?
?   UI instantly updates                                                  ?
?                                                                         ?
???????????????????????????????????????????????????????????????????????????
```

---

## Data Flow Patterns

### Pattern 1: Simple Query (Read)

```
????????????????
?   Browser    ?
?              ?
?  Click link  ?
?  /devices    ?
????????????????
       ?
       ? 1. HTTP GET
       ?
?????????????????????????????????????????????????
?            Server                             ?
?                                               ?
?  2. Route to Devices.razor                    ?
?                                               ?
?  3. Inject IDbContextFactory                  ?
?     ???????????????????????????????           ?
?     ? @inject IDbContextFactory   ?           ?
?     ?   <AppDbContext> DbFactory  ?           ?
?     ???????????????????????????????           ?
?                                               ?
?  4. OnInitializedAsync()                      ?
?     ????????????????????????????????????????  ?
?     ? await using var db = await           ?  ?
?     ?   DbFactory.CreateDbContextAsync();  ?  ?
?     ?                                      ?  ?
?     ? devices = await db.Devices           ?  ?
?     ?   .AsNoTracking()                    ?  ?
?     ?   .ToListAsync();                    ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  5. EF Core Query  ?                          ?
?     ????????????????????????????????????????  ?
?     ? SELECT Id, Name, Status, Type        ?  ?
?     ? FROM Devices                         ?  ?
?     ? ORDER BY Name                        ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  6. SQLite Read    ?                          ?
?     ????????????????????????????????????????  ?
?     ? ????????????????????????????????     ?  ?
?     ? ? app.db (Devices table)       ?     ?  ?
?     ? ????????????????????????????????     ?  ?
?     ? Returns 20 rows                      ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  7. Materialize    ?                          ?
?     ????????????????????????????????????????  ?
?     ? List<Device> {                       ?  ?
?     ?   new Device { Id="device-01",       ?  ?
?     ?                Name="DisplayWall-1"}, ?  ?
?     ?   ...                                ?  ?
?     ? }                                    ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  8. Render         ?                          ?
?     ????????????????????????????????????????  ?
?     ? <table>                              ?  ?
?     ?   @foreach(var d in devices)         ?  ?
?     ?   <tr><td>@d.Name</td></tr>          ?  ?
?     ? </table>                             ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?????????????????????????????????????????????????
                     ?
                     ? 9. SignalR: HTML
                     ?
?????????????????????????????????
?          Browser              ?
?                               ?
?  10. Display table            ?
?      ????????????????????     ?
?      ? DisplayWall-1    ?     ?
?      ? DisplayWall-2    ?     ?
?      ? DisplayWall-3    ?     ?
?      ????????????????????     ?
?                               ?
?????????????????????????????????
```

### Pattern 2: Command with Validation (Create/Update)

```
????????????????
?   Browser    ?
?              ?
?  Fill form   ?
?  Click Save  ?
????????????????
       ?
       ? 1. SignalR: Button click + form data
       ?
?????????????????????????????????????????????????
?            Server                             ?
?                                               ?
?  2. Execute SaveDevice() method               ?
?     ????????????????????????????????????????  ?
?     ? private async Task SaveDevice()      ?  ?
?     ? {                                    ?  ?
?     ?   // Validate                        ?  ?
?     ?   if (string.IsNullOrEmpty(Name))    ?  ?
?     ?     return; // Show error            ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  3. Create DbContext                          ?
?     ????????????????????????????????????????  ?
?     ? await using var db = await           ?  ?
?     ?   DbFactory.CreateDbContextAsync();  ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  4. Create Entity  ?                          ?
?     ????????????????????????????????????????  ?
?     ? var device = new Device {            ?  ?
?     ?   Id = Guid.NewGuid().ToString(),    ?  ?
?     ?   Name = deviceName,                 ?  ?
?     ?   Status = DeviceStatus.Offline      ?  ?
?     ? };                                   ?  ?
?     ? db.Devices.Add(device);              ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  5. Save Changes   ?                          ?
?     ????????????????????????????????????????  ?
?     ? await db.SaveChangesAsync();         ?  ?
?     ?   ?                                  ?  ?
?     ? EF Core Change Tracker               ?  ?
?     ?   ?                                  ?  ?
?     ? Generate SQL                         ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  6. Execute SQL    ?                          ?
?     ????????????????????????????????????????  ?
?     ? INSERT INTO Devices                  ?  ?
?     ?   (Id, Name, Status, Type,...)       ?  ?
?     ? VALUES                               ?  ?
?     ?   ('abc-123', 'DisplayWall-21',      ?  ?
?     ?    0, 1, ...)                        ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  7. SQLite Write   ?                          ?
?     ????????????????????????????????????????  ?
?     ? ????????????????????????????????     ?  ?
?     ? ? app.db                       ?     ?  ?
?     ? ? Devices table                ?     ?  ?
?     ? ? [New row inserted]           ?     ?  ?
?     ? ????????????????????????????????     ?  ?
?     ? Returns: 1 row affected              ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?  8. Navigate       ?                          ?
?     ????????????????????????????????????????  ?
?     ? Navigation.NavigateTo("/devices");   ?  ?
?     ????????????????????????????????????????  ?
?                    ?                          ?
?????????????????????????????????????????????????
                     ?
                     ? 9. SignalR: Navigate command
                     ?
?????????????????????????????????
?          Browser              ?
?                               ?
?  10. Navigate to /devices     ?
?      (Shows updated list)     ?
?                               ?
?????????????????????????????????
```

---

## SignalR Communication

### Dual SignalR Architecture

```
??????????????????????????????????????????????????????????????????????????????
?                          ASP.NET CORE SERVER                               ?
?                                                                            ?
?  ????????????????????????????????????????????????????????????????????????  ?
?  ?                      SignalR Hub Routing                             ?  ?
?  ?                                                                      ?  ?
?  ?  /_blazor  ??????????????> Blazor Hub (Auto-created)                ?  ?
?  ?                            - Component lifecycle                     ?  ?
?  ?                            - UI state sync                           ?  ?
?  ?                            - Event handling                          ?  ?
?  ?                                                                      ?  ?
?  ?  /controlhub ????????????> ControlHub (Custom)                      ?  ?
?  ?                            - Operator commands                       ?  ?
?  ?                            - Device status broadcast                 ?  ?
?  ?                            - Real-time updates                       ?  ?
?  ?                                                                      ?  ?
?  ?  /devicehub ?????????????> DeviceHub (Custom)                       ?  ?
?  ?                            - Device connections                      ?  ?
?  ?                            - Telemetry ingestion                     ?  ?
?  ?                            - Command execution                       ?  ?
?  ?                                                                      ?  ?
?  ????????????????????????????????????????????????????????????????????????  ?
?                                                                            ?
??????????????????????????????????????????????????????????????????????????????
```

### SignalR Message Flow

```
                           OPERATOR SENDS COMMAND
                           
????????????????                                          ????????????????
?  Operator    ?                                          ?   Device     ?
?  Browser     ?                                          ?   Agent      ?
????????????????                                          ????????????????
       ?                                                          ?
       ? 1. User clicks "Reboot Device"                           ?
       ?                                                          ?
       ? 2. @onclick="() => SendCommand("Reboot")"                ?
       ?                                                          ?
       ? 3. SignalR: controlHub.InvokeAsync("ExecuteCommand")     ?
       ?                                                          ?
?????????????????????????????????????????????????????????????????????????
?                        SERVER: ControlHub                             ?
?                                                                       ?
?  public async Task ExecuteCommand(string deviceId, string cmd)        ?
?  {                                                                    ?
?    // 4. Create command in database                                  ?
?    await using var db = await _factory.CreateDbContextAsync();       ?
?    var command = new DeviceCommand                                   ?
?    {                                                                 ?
?      Id = Guid.NewGuid(),                                            ?
?      DeviceId = deviceId,                                            ?
?      Command = cmd,                                                  ?
?      Status = "Pending",                                             ?
?      IdempotencyKey = Guid.NewGuid().ToString()                      ?
?    };                                                                ?
?    db.Commands.Add(command);                                         ?
?    await db.SaveChangesAsync();                                      ?
?                                                                       ?
?    // 5. Notify CommandRouter (background service)                   ?
?    await _mediator.Publish(new CommandCreatedEvent(command.Id));     ?
?  }                                                                    ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
                              ?
                              ? 6. CommandRouter picks up command
                              ?
?????????????????????????????????????????????????????????????????????????
?                    SERVER: CommandRouter                              ?
?                                                                       ?
?  // Background service continuously processes commands                ?
?  while (!stoppingToken.IsCancellationRequested)                       ?
?  {                                                                    ?
?    var pendingCommands = await db.Commands                            ?
?      .Where(c => c.Status == "Pending")                               ?
?      .ToListAsync();                                                  ?
?                                                                       ?
?    foreach (var cmd in pendingCommands)                               ?
?    {                                                                  ?
?      // 7. Route to device via DeviceHub                             ?
?      await _deviceHub.Clients                                         ?
?        .Client(cmd.DeviceId)                                          ?
?        .SendAsync("ExecuteCommand", cmd);                             ?
?    }                                                                  ?
?  }                                                                    ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
                              ?
                              ? 8. SignalR: Forward command to device
                              ?
                      ????????????????
                      ?  DeviceHub   ?
                      ?  Connection  ?
                      ????????????????
                              ?
                              ? 9. Device receives command
                              ?
?????????????????????????????????????????????????????????????????????????
?                         DEVICE AGENT                                  ?
?                                                                       ?
?  hubConnection.On<DeviceCommand>("ExecuteCommand", async (cmd) =>     ?
?  {                                                                    ?
?    // 10. Execute command locally                                    ?
?    var result = await _protocol.ExecuteAsync(cmd.Command);            ?
?                                                                       ?
?    // 11. Report result back to server                               ?
?    await hubConnection.InvokeAsync("ReportCommandResult",             ?
?      cmd.Id, result.Success, result.Message);                         ?
?  });                                                                  ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
                              ?
                              ? 12. SignalR: Send result
                              ?
?????????????????????????????????????????????????????????????????????????
?                    SERVER: DeviceHub                                  ?
?                                                                       ?
?  public async Task ReportCommandResult(Guid cmdId, bool success)      ?
?  {                                                                    ?
?    // 13. Update database                                            ?
?    await using var db = await _factory.CreateDbContextAsync();       ?
?    var cmd = await db.Commands.FindAsync(cmdId);                     ?
?    cmd.Status = success ? "Completed" : "Failed";                    ?
?    cmd.Result = result;                                              ?
?    await db.SaveChangesAsync();                                      ?
?                                                                       ?
?    // 14. Broadcast to all operators                                 ?
?    await _controlHub.Clients.All                                     ?
?      .SendAsync("CommandCompleted", cmd);                            ?
?  }                                                                    ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
                              ?
                              ? 15. SignalR: Broadcast update
                              ?
?????????????????????????????????????????????????????????????????????????
?                    OPERATOR BROWSER                                   ?
?                                                                       ?
?  // Blazor component listening for updates                            ?
?  hubConnection.On<DeviceCommand>("CommandCompleted", (cmd) =>         ?
?  {                                                                    ?
?    // 16. Update UI                                                  ?
?    var command = commands.FirstOrDefault(c => c.Id == cmd.Id);        ?
?    if (command != null)                                              ?
?    {                                                                 ?
?      command.Status = cmd.Status;                                    ?
?      command.Result = cmd.Result;                                    ?
?      await InvokeAsync(StateHasChanged); // Re-render                ?
?    }                                                                 ?
?  });                                                                  ?
?                                                                       ?
?  UI shows: ? Command completed successfully                          ?
?                                                                       ?
?????????????????????????????????????????????????????????????????????????
```

---

## Command Pipeline

### Command Processing Flow with Resilience

```
????????????????????????????????????????????????????????????????????????????
?                       COMMAND PIPELINE                                   ?
????????????????????????????????????????????????????????????????????????????

        ???????????????
        ?   Operator  ?
        ?  Creates    ?
        ?  Command    ?
        ???????????????
               ?
               ? 1. POST /api/devices/{id}/commands
               ?    Body: { "command": "Reboot" }
               ?
????????????????????????????????????????????????????????????????????????????
?                    DevicesController.ExecuteCommand                      ?
?                                                                          ?
?  [HttpPost("{id}/commands")]                                             ?
?  public async Task<IResult> ExecuteCommand(string id, CommandDto dto)    ?
?  {                                                                       ?
?    // Validation                                                         ?
?    if (!await _validator.ValidateAsync(dto))                             ?
?      return Results.BadRequest();                                        ?
?                                                                          ?
?    // Create command record                                              ?
?    await using var db = await _factory.CreateDbContextAsync();          ?
?    var command = new DeviceCommand                                      ?
?    {                                                                    ?
?      Id = Guid.NewGuid(),                                               ?
?      DeviceId = id,                                                     ?
?      Command = dto.Command,                                             ?
?      Status = "Pending",                                                ?
?      IdempotencyKey = dto.IdempotencyKey,                               ?
?      CreatedUtc = DateTime.UtcNow                                       ?
?    };                                                                   ?
?    db.Commands.Add(command);                                            ?
?    await db.SaveChangesAsync();                                         ?
?                                                                          ?
?    return Results.Accepted($"/api/commands/{command.Id}", command);     ?
?  }                                                                       ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
               ?
               ? 2. Command saved to database
               ?
????????????????????????????????????????????????????????????????????????????
?                        SQLite Database                                   ?
?                                                                          ?
?  Commands Table:                                                         ?
?  ?????????????????????????????????????????????????????????????????????  ?
?  ? Id         ? DeviceId  ? Command ? Status   ? IdempotencyKey      ?  ?
?  ?????????????????????????????????????????????????????????????????????  ?
?  ? guid-123   ? device-01 ? Reboot  ? Pending  ? key-abc             ?  ?
?  ?????????????????????????????????????????????????????????????????????  ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
               ?
               ? 3. CommandRouter polls for pending commands
               ?    (Background Service, runs every 1s)
               ?
????????????????????????????????????????????????????????????????????????????
?                      CommandRouter (HostedService)                       ?
?                                                                          ?
?  protected override async Task ExecuteAsync(CancellationToken token)     ?
?  {                                                                       ?
?    while (!token.IsCancellationRequested)                                ?
?    {                                                                     ?
?      await ProcessPendingCommands();                                     ?
?      await Task.Delay(1000, token);                                      ?
?    }                                                                     ?
?  }                                                                       ?
?                                                                          ?
?  private async Task ProcessPendingCommands()                             ?
?  {                                                                       ?
?    await using var db = await _factory.CreateDbContextAsync();          ?
?    var commands = await db.Commands                                     ?
?      .Where(c => c.Status == "Pending")                                  ?
?      .OrderBy(c => c.CreatedUtc)                                         ?
?      .Take(10)                                                           ?
?      .ToListAsync();                                                     ?
?                                                                          ?
?    foreach (var cmd in commands)                                         ?
?    {                                                                     ?
?      await RouteCommandToDevice(cmd);                                    ?
?    }                                                                     ?
?  }                                                                       ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
               ?
               ? 4. Route to DeviceHub with Polly resilience
               ?
????????????????????????????????????????????????????????????????????????????
?                    CommandRouter.RouteCommandToDevice                    ?
?                                                                          ?
?  private async Task RouteCommandToDevice(DeviceCommand cmd)              ?
?  {                                                                       ?
?    var policy = Policy                                                   ?
?      .Handle<Exception>()                                                ?
?      .WaitAndRetryAsync(3,                                               ?
?        retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)), ?
?        onRetry: (ex, time, retry, ctx) =>                                ?
?        {                                                                 ?
?          Log.Warning("Retry {Retry} for command {Id}", retry, cmd.Id);   ?
?        });                                                               ?
?                                                                          ?
?    await policy.ExecuteAsync(async () =>                                 ?
?    {                                                                     ?
?      // Check if device is connected                                    ?
?      var isConnected = _deviceCircuits.IsConnected(cmd.DeviceId);        ?
?      if (!isConnected)                                                   ?
?      {                                                                   ?
?        Log.Warning("Device {Id} not connected", cmd.DeviceId);           ?
?        return; // Will retry                                            ?
?      }                                                                   ?
?                                                                          ?
?      // Send via DeviceHub                                              ?
?      await _deviceHub.Clients                                            ?
?        .Client(cmd.DeviceId)                                             ?
?        .SendAsync("ExecuteCommand", cmd);                                ?
?                                                                          ?
?      // Update status                                                   ?
?      cmd.Status = "Sent";                                               ?
?      await _db.SaveChangesAsync();                                       ?
?    });                                                                   ?
?  }                                                                       ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
               ?
               ? 5. SignalR sends to device
               ?
????????????????????????????????????????????????????????????????????????????
?                           Edge Device                                    ?
?                                                                          ?
?  hubConnection.On<DeviceCommand>("ExecuteCommand", async (cmd) =>        ?
?  {                                                                       ?
?    Log.Information("Executing {Command} on {Device}",                    ?
?      cmd.Command, cmd.DeviceId);                                         ?
?                                                                          ?
?    // Execute via protocol adapter                                      ?
?    var adapter = _protocolFactory.GetAdapter(device.Protocol);           ?
?    var result = await adapter.ExecuteAsync(cmd.Command);                 ?
?                                                                          ?
?    // Report back                                                       ?
?    await hubConnection.InvokeAsync("ReportResult",                       ?
?      cmd.Id, result.Success, result.Message);                            ?
?  });                                                                     ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
               ?
               ? 6. Device reports result
               ?
????????????????????????????????????????????????????????????????????????????
?                         DeviceHub.ReportResult                           ?
?                                                                          ?
?  public async Task ReportResult(Guid cmdId, bool success, string msg)    ?
?  {                                                                       ?
?    await using var db = await _factory.CreateDbContextAsync();          ?
?    var cmd = await db.Commands.FindAsync(cmdId);                        ?
?    cmd.Status = success ? "Completed" : "Failed";                       ?
?    cmd.Result = msg;                                                    ?
?    cmd.LatencyMs = (DateTime.UtcNow - cmd.CreatedUtc).TotalMilliseconds;?
?    await db.SaveChangesAsync();                                         ?
?                                                                          ?
?    // Broadcast to operators                                            ?
?    await _controlHub.Clients.All                                        ?
?      .SendAsync("CommandCompleted", cmd);                               ?
?                                                                          ?
?    // Update metrics                                                    ?
?    MetricsEndpoint.Set($"command.{cmd.Command}.latency_ms",             ?
?      cmd.LatencyMs.Value);                                              ?
?  }                                                                       ?
?                                                                          ?
????????????????????????????????????????????????????????????????????????????
```

---

## Database Schema

### Entity Relationship Diagram

```
???????????????????????????????????????????????????????????????????????????
?                         SQLITE DATABASE SCHEMA                          ?
???????????????????????????????????????????????????????????????????????????

????????????????????????????????????????
?           Devices                    ?
????????????????????????????????????????
? PK  Id              TEXT             ? ????
?     Name            TEXT             ?    ?
?     Type            INTEGER          ?    ?  One-to-Many
?     Protocol        INTEGER          ?    ?
?     Capabilities    TEXT (JSON)      ?    ?
?     Status          INTEGER          ?    ?
?     LastSeenUtc     TEXT (DateTime)  ?    ?
?     Firmware        TEXT             ?    ?
?     Location        TEXT             ?    ?
?     RowVersion      BLOB             ?    ?
?                                      ?    ?
? Indexes:                             ?    ?
?   IX_Devices_Status_Type             ?    ?
????????????????????????????????????????    ?
                                            ?
                                            ?
                ?????????????????????????????????????????????????????????
                ?                           ?                           ?
                ?                           ?                           ?
???????????????????????????????  ???????????????????????????  ?????????????????????????
?     Commands                ?  ?   Telemetry             ?  ?  __EFMigrationsHistory?
???????????????????????????????  ???????????????????????????  ?????????????????????????
? PK  Id           TEXT       ?  ? PK  Id      TEXT        ?  ? PK MigrationId  TEXT  ?
? FK  DeviceId     TEXT       ?  ? FK  DeviceId TEXT       ?  ?    ProductVersion TEXT?
?     Command      TEXT       ?  ?     TimestampUtc TEXT   ?  ?                       ?
?     CreatedUtc   TEXT       ?  ?     Json        TEXT    ?  ? Stores applied        ?
?     Status       TEXT       ?  ?                         ?  ? migrations            ?
?     Result       TEXT       ?  ? Stores device metrics   ?  ?????????????????????????
?     LatencyMs    INTEGER    ?  ? in JSON format          ?
?     IdempotencyKey TEXT     ?  ?                         ?
?                             ?  ? Indexes:                ?
? Indexes:                    ?  ?   IX_Telemetry_         ?
?   IX_Commands_DeviceId_     ?  ?     DeviceId_           ?
?     IdempotencyKey (UNIQUE) ?  ?     TimestampUtc        ?
???????????????????????????????  ???????????????????????????
```

### Example Data

```sql
-- Devices Table
INSERT INTO Devices (Id, Name, Type, Protocol, Capabilities, Status, LastSeenUtc, Firmware, Location)
VALUES 
('device-01', 'DisplayWall-1', 0, 1, '["Ping","GetStatus","Reboot"]', 1, '2024-01-15 10:30:00', 'v1.2.3', 'ControlRoomA'),
('device-02', 'DisplayWall-2', 1, 0, '["Ping","GetStatus","Reboot","SetBrightness"]', 1, '2024-01-15 10:31:00', 'v1.2.3', 'ControlRoomA');

-- Commands Table
INSERT INTO Commands (Id, DeviceId, Command, CreatedUtc, Status, Result, LatencyMs, IdempotencyKey)
VALUES
('cmd-guid-1', 'device-01', 'Reboot', '2024-01-15 10:00:00', 'Completed', 'Success', 1234, 'idempotency-key-1'),
('cmd-guid-2', 'device-01', 'GetStatus', '2024-01-15 10:05:00', 'Pending', NULL, NULL, 'idempotency-key-2');

-- Telemetry Table
INSERT INTO Telemetry (Id, DeviceId, TimestampUtc, Json)
VALUES
('telemetry-guid-1', 'device-01', '2024-01-15 10:30:00', '{"temperature":45.2,"uptime":86400}'),
('telemetry-guid-2', 'device-01', '2024-01-15 10:31:00', '{"temperature":45.5,"uptime":86460}');
```

---

## Summary

This architecture provides:

1. **Separation of Concerns**
   - Presentation (Blazor/SignalR)
   - Application (Services/Pipelines)
   - Domain (Entities)
   - Infrastructure (Database)

2. **Real-Time Communication**
   - Blazor Hub: Browser ? Server component sync
   - ControlHub: Operator ? System commands
   - DeviceHub: Devices ? System telemetry

3. **Data Persistence**
   - Entity Framework Core with SQLite
   - Migrations for schema evolution
   - Factory pattern for DbContext lifecycle

4. **Resilience**
   - Retry with exponential backoff
   - Circuit breakers
   - Idempotency keys
   - Background processing

5. **Security**
   - Server-side execution (no client-side database access)
   - API key authentication
   - Validation at all layers

**The browser is purely a presentation layer. All business logic, database access, and state management happens on the server, communicated via SignalR.**
